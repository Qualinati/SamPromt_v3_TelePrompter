<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompter Pro V3 (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        accent: { DEFAULT: '#3B82F6', dark: '#2563EB' },
                        darkbg: '#0F172A',
                        surface: '#1E293B'
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #prompter-text-container {
            scroll-behavior: smooth;
            height: 70vh;
            overflow-y: auto;
            padding-top: 40vh;
            padding-bottom: 50vh;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        }
        .highlighted-word {
            color: #3B82F6;
            text-shadow: 0 0 25px rgba(59, 130, 246, 0.9);
            transform: scale(1.15);
            display: inline-block;
            transition: all 0.1s ease-out;
        }
        .glass {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="bg-darkbg text-gray-200 font-sans min-h-screen overflow-hidden relative selection:bg-accent selection:text-white">

    <nav class="flex justify-between items-center p-6 relative z-20">
        <h1 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
            Teleprompter Pro <span class="text-xs bg-green-600 text-white px-2 py-1 rounded ml-2 align-middle">V3.0</span>
        </h1>
        <button onclick="window.location.reload()" class="text-sm text-gray-400 hover:text-white transition">⟳ Yenile</button>
    </nav>

    <main class="container mx-auto px-4 relative z-10 h-full flex flex-col items-center justify-center">
        <section id="editor-mode" class="w-full max-w-4xl transition-all duration-500">
            <div class="glass rounded-2xl p-6 md:p-8 shadow-2xl border-t border-white/10">
                <div class="mb-4 flex justify-between items-center">
                    <label class="text-gray-400 text-sm font-semibold uppercase tracking-wider">Okunacak Metin</label>
                    <span class="text-xs text-gray-500">İpucu: Metni yapıştır ve başla</span>
                </div>
                <textarea id="source-text" class="w-full h-80 bg-darkbg/60 p-5 rounded-xl border border-gray-700/50 outline-none resize-none text-lg text-gray-200 focus:border-accent focus:ring-1 focus:ring-accent transition" placeholder="Metnini buraya yapıştır..."></textarea>
                <div class="flex justify-center mt-6">
                    <button onclick="startPrompter()" class="px-10 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-full font-bold shadow-lg shadow-blue-900/50 transition-all transform hover:scale-[1.02] active:scale-95">
                        Sunumu Başlat
                    </button>
                </div>
            </div>
        </section>

        <section id="prompter-mode" class="hidden w-full max-w-6xl relative h-screen flex flex-col">
            <div id="prompter-text-container" class="no-scrollbar text-4xl md:text-6xl font-bold text-center leading-snug text-gray-600 select-none px-4 md:px-20 tracking-tight"></div>

            <div class="fixed bottom-10 left-1/2 transform -translate-x-1/2 w-full max-w-xl px-6 z-50 flex flex-col items-center gap-4">
                
                <div id="status-bubble" class="px-4 py-1.5 rounded-full bg-black/60 backdrop-blur text-xs font-mono text-gray-400 transition-colors duration-300 border border-white/5">
                    Mikrofon bekleniyor...
                </div>

                <div class="glass rounded-full p-2.5 flex items-center gap-4 shadow-2xl bg-gray-900/90 border border-white/10">
                    <button onclick="stopPrompter()" class="p-4 rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition" title="Düzenlemeye Dön">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                    </button>
                    
                    <button id="mic-btn" onclick="toggleMicrophone()" class="relative p-6 bg-accent rounded-full text-white shadow-lg shadow-blue-500/30 transition-all transform hover:scale-105 active:scale-95 group">
                        <span id="mic-pulse" class="absolute inset-0 rounded-full bg-white opacity-0 transition-opacity duration-1000"></span>
                        <svg id="mic-icon" class="w-8 h-8 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>

                    <button onclick="resetReadingPos()" class="p-4 rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition" title="Başa Sar">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // DOM Elementleri
        const els = {
            editor: document.getElementById('editor-mode'),
            prompter: document.getElementById('prompter-mode'),
            source: document.getElementById('source-text'),
            container: document.getElementById('prompter-text-container'),
            status: document.getElementById('status-bubble'),
            micBtn: document.getElementById('mic-btn'),
            micPulse: document.getElementById('mic-pulse')
        };

        // Durum Değişkenleri
        let state = {
            recognition: null,
            isListening: false,
            shouldListen: false,
            words: [],      // DOM elementleri
            cleanText: [],  // Karşılaştırma metni
            currentIndex: 0
        };

        // === 1. BAŞLATMA VE KONFİGÜRASYON ===
        function initSpeech() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Tarayıcınız ses tanımayı desteklemiyor. Chrome kullanın.");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = new SpeechRecognition();
            state.recognition.continuous = true;
            state.recognition.interimResults = true;
            state.recognition.lang = 'tr-TR';

            state.recognition.onstart = () => {
                state.isListening = true;
                updateMicUI(true);
                updateStatus("Dinliyorum...", "text-green-400");
            };

            state.recognition.onend = () => {
                state.isListening = false;
                if (state.shouldListen) {
                    updateStatus("Bağlantı tazelexeniyor...", "text-yellow-400");
                    try { state.recognition.start(); } catch(e) {}
                } else {
                    updateMicUI(false);
                    updateStatus("Duraklatıldı", "text-gray-400");
                }
            };

            state.recognition.onerror = (event) => {
                if (event.error === 'not-allowed') {
                    state.shouldListen = false;
                    alert("Mikrofon izni verilmedi!");
                }
            };

            state.recognition.onresult = (event) => {
                // Sonuçları işle
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                
                if (transcript.trim()) {
                    handleInput(transcript.toLowerCase().trim());
                    // Debug için ekrana yazdırılabilir ama kullanıcı görmesin
                }
            };
        }

        // === 2. ÇEKİRDEK MANTIK (THE BRAIN) ===
        
        function handleInput(transcript) {
            // Son söylenen kelimeleri al
            const spokenWords = transcript.split(/\s+/);
            const lastWord = spokenWords[spokenWords.length - 1];
            if (!lastWord || lastWord.length < 2) return;

            // --- V3 GÜNCELLEMESİ: AKILLI ARAMA ---
            // Arama menzilini daralt (Sadece önümüzdeki 15 kelimeye bak)
            // Bu "Greedy Match" (Hatalı atlama) sorununu çözer.
            const SEARCH_HORIZON = 15; 
            const searchEnd = Math.min(state.currentIndex + SEARCH_HORIZON, state.cleanText.length);

            for (let i = state.currentIndex; i < searchEnd; i++) {
                const targetWord = state.cleanText[i];
                const distance = i - state.currentIndex;

                let isMatch = false;

                // A. Yakın Mesafe (0-5 kelime): Esnek Eşleşme
                if (distance < 5) {
                    // Kelime içeriyor mu? (Örn: "konular" -> "konu")
                    if (targetWord === lastWord || (lastWord.length > 3 && targetWord.includes(lastWord))) {
                        isMatch = true;
                    }
                } 
                // B. Orta Mesafe (5-15 kelime): Sıkı Eşleşme
                else {
                    // Kesin eşleşme şart (Hatalı atlamayı önler)
                    if (targetWord === lastWord) {
                        isMatch = true;
                    }
                }

                if (isMatch) {
                    scrollToIndex(i);
                    state.currentIndex = i + 1;
                    return; // İlk bulduğunda dur, daha ileriye gitme!
                }
            }
        }

        function scrollToIndex(index) {
            // Görsel güncelleme
            state.words.forEach((el, i) => {
                if (i === index) {
                    el.className = 'highlighted-word text-white opacity-100';
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else if (i < index) {
                    el.className = 'inline-block opacity-20 transition-opacity duration-500 blur-[1px]'; // Okunanlar flu
                } else {
                    el.className = 'inline-block opacity-50 transition-opacity duration-300'; // Gelecekler
                }
            });
        }

        // === 3. YARDIMCI İŞLEMLER ===

        function startPrompter() {
            const text = els.source.value.trim();
            if (!text) return alert("Lütfen metin girin.");

            // Metni Parçala
            els.container.innerHTML = '';
            state.words = [];
            state.cleanText = [];
            state.currentIndex = 0;

            // Yeni satırları koru ama kelimeleri ayır
            text.split(/(\s+)/).forEach(part => {
                if (part.trim().length > 0) {
                    const span = document.createElement('span');
                    span.textContent = part; // Boşluksuz kelime
                    span.className = 'inline-block opacity-50 transition-opacity duration-300 mx-1.5 my-1'; // Kelime arası boşluk margin ile
                    els.container.appendChild(span);
                    state.words.push(span);
                    
                    // Temiz metin (noktalama yok)
                    state.cleanText.push(part.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""));
                } else if (part.includes('\n')) {
                    // Paragraf boşluğu
                    els.container.appendChild(document.createElement('br'));
                    els.container.appendChild(document.createElement('br'));
                }
            });

            // UI Geçişi
            els.editor.classList.add('hidden');
            els.prompter.classList.remove('hidden');
            
            // Başlat
            if (!state.recognition) initSpeech();
            toggleMicrophone();
        }

        function stopPrompter() {
            state.shouldListen = false;
            if (state.recognition) state.recognition.stop();
            els.prompter.classList.add('hidden');
            els.editor.classList.remove('hidden');
        }

        function toggleMicrophone() {
            if (!state.recognition) initSpeech();
            
            if (state.shouldListen) {
                state.shouldListen = false;
                state.recognition.stop();
            } else {
                state.shouldListen = true;
                try { state.recognition.start(); } catch(e) {}
            }
        }

        function resetReadingPos() {
            state.currentIndex = 0;
            scrollToIndex(0);
        }

        function updateMicUI(isActive) {
            if (isActive) {
                els.micBtn.classList.add('bg-red-500', 'ring-4', 'ring-red-500/30');
                els.micBtn.classList.remove('bg-accent');
                els.micPulse.classList.add('animate-ping', 'opacity-30');
            } else {
                els.micBtn.classList.remove('bg-red-500', 'ring-4', 'ring-red-500/30');
                els.micBtn.classList.add('bg-accent');
                els.micPulse.classList.remove('animate-ping', 'opacity-30');
            }
        }

        function updateStatus(msg, colorClass) {
            els.status.textContent = msg;
            els.status.className = `px-4 py-1.5 rounded-full bg-black/60 backdrop-blur text-xs font-mono transition-colors duration-300 border border-white/5 ${colorClass}`;
        }
        
        // Örnek Metin
        els.source.value = "Hoş geldin! V3 Güncellemesi devrede.\n\nArtık 'hakkında' gibi kelimeler metnin içinde birden fazla kez geçse bile sistem kafasına göre atlamayacak. Sadece senin okuduğun satırı ve hemen önündeki birkaç kelimeyi takip edecek.\n\nBuna 'Kısa Tasma' teknolojisi diyoruz. Böylece kontrol tamamen sende, sistem sadece seni takip eder, önüne geçmez.\n\nHadi test edelim!";

    </script>
</body>
</html>
